<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales Report Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --input-bg: #ffffff;
            --table-hover: #f8f9fa;
            --metrics-bg: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: #2d2d44;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444466;
            --input-bg: #3d3d5c;
            --table-hover: #3d3d5c;
            --metrics-bg: #3d3d5c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--metrics-bg);
            transform: scale(1.05);
        }

        .role-selector {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .role-selector select {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 10px;
        }

        .role-manager { background: #667eea; color: white; }
        .role-analyst { background: #28a745; color: white; }
        .role-viewer { background: #6c757d; color: white; }

        .alerts-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }

        .alerts-section.active {
            display: block;
        }

        .alerts-section h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.15);
            border-left: 4px solid #ffc107;
            color: var(--text-primary);
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.15);
            border-left: 4px solid #28a745;
            color: var(--text-primary);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.15);
            border-left: 4px solid #dc3545;
            color: var(--text-primary);
        }

        .alert-info {
            background: rgba(23, 162, 184, 0.15);
            border-left: 4px solid #17a2b8;
            color: var(--text-primary);
        }

        .history-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .history-section h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .history-controls input[type="date"] {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
        }

        .history-table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .history-table th {
            background: var(--metrics-bg);
            font-weight: 600;
        }

        .history-table tr:hover {
            background: var(--table-hover);
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .trend-neutral {
            color: #6c757d;
        }

        .history-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .controls-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .controls-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .source-panel {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .source-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .source-panel h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .input-group input.invalid,
        .input-group textarea.invalid {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .manager-notes {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .manager-notes h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .manager-notes textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            min-height: 100px;
            background: var(--input-bg);
            color: var(--text-primary);
            resize: vertical;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #28a745;
            color: white;
        }

        .btn-secondary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .report-preview {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .report-preview.active {
            display: block;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }

        .report-header h2 {
            color: var(--text-primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .report-header .date {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .report-metadata {
            display: flex;
            justify-content: space-between;
            background: var(--metrics-bg);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .metadata-item {
            display: flex;
            flex-direction: column;
        }

        .metadata-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metadata-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .goal-tracking {
            background: var(--metrics-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .goal-tracking h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .goal-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .goal-stat {
            flex: 1;
            min-width: 150px;
        }

        .goal-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .goal-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .goal-status {
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
        }

        .goal-status.met {
            background: #28a745;
            color: white;
        }

        .goal-status.not-met {
            background: #ffc107;
            color: #333;
        }

        .charts-section {
            margin-bottom: 30px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--metrics-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .chart-card h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .report-table th,
        .report-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .report-table th {
            background: var(--metrics-bg);
            color: var(--text-primary);
            font-weight: 600;
        }

        .report-table tr:hover {
            background: var(--table-hover);
        }

        .report-table .totals-row {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .report-table .totals-row:hover {
            background: #667eea;
        }

        .metrics {
            background: var(--metrics-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .metrics h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-value {
            color: #667eea;
            font-weight: 600;
            font-size: 18px;
        }

        .manager-remarks {
            background: var(--metrics-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .manager-remarks h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .manager-remarks-text {
            color: var(--text-secondary);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .performance-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .performance-above {
            background: #28a745;
            color: white;
        }

        .performance-below {
            background: #dc3545;
            color: white;
        }

        .performance-average {
            background: #ffc107;
            color: #333;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
                margin-top: 30px;
            }

            .role-selector {
                position: static;
                margin-bottom: 15px;
                text-align: center;
            }

            .theme-toggle {
                position: static;
                display: block;
                margin: 0 auto 15px;
            }

            .input-section {
                grid-template-columns: 1fr;
            }

            .report-preview {
                padding: 20px;
            }

            .report-table {
                font-size: 14px;
            }

            .report-table th,
            .report-table td {
                padding: 8px;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 250px;
            }

            .report-metadata {
                flex-direction: column;
            }

            .history-table {
                font-size: 12px;
            }

            .history-table th,
            .history-table td {
                padding: 8px;
            }

            .controls-row {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="role-selector">
                <select id="userRole" onchange="updateRolePermissions()">
                    <option value="manager">üëî Manager</option>
                    <option value="analyst">üìä Analyst</option>
                    <option value="viewer">üëÅÔ∏è Viewer</option>
                </select>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåì Toggle Theme</button>
            <h1>Daily Sales Report Generator <span class="role-badge role-manager" id="roleBadge">MANAGER</span></h1>
            <p>Automated Multi-Source Sales Reporting Tool</p>
        </div>

        <div class="alerts-section" id="alertsSection">
            <h3>üîî Smart Alerts</h3>
            <div id="alertsContainer"></div>
        </div>

        <div class="controls-section">
            <div class="controls-row">
                <div class="control-group">
                    <label>Report Date</label>
                    <input type="date" id="reportDateInput" value="">
                </div>
                <div class="control-group">
                    <label>Daily Sales Target ($)</label>
                    <input type="number" id="dailyTarget" step="0.01" placeholder="Enter target (optional)">
                </div>
                <button class="btn btn-warning btn-small" onclick="autoFillDemo()">üé≤ Auto-Fill Demo Data</button>
                <button class="btn btn-info btn-small" onclick="saveReport()">üíæ Save Report</button>
                <button class="btn btn-info btn-small" onclick="loadReport()">üìÇ Load Last Report</button>
                <button class="btn btn-primary btn-small" onclick="saveAsNewDay()" id="saveNewDayBtn">üìÖ Save as New Day</button>
            </div>
        </div>

        <div class="history-section">
            <h3>üìä Historical Performance Tracking</h3>
            <div class="history-controls">
                <button class="btn btn-info btn-small" onclick="loadHistoricalReport()">üìñ Load Historical Report</button>
                <button class="btn btn-danger btn-small" onclick="clearHistory()">üóëÔ∏è Clear All History</button>
            </div>
            <div class="history-table-wrapper">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Sales</th>
                            <th>Trend vs Previous</th>
                            <th>Transactions</th>
                            <th>Target Status</th>
                            <th>Best Source</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="7" class="history-empty">No historical data available. Generate and save reports to see history.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="input-section">
            <div class="source-panel">
                <h3>Source 1 Sales</h3>
                <div class="input-group">
                    <label>Total Sales Amount ($)</label>
                    <input type="number" id="sales1" step="0.01" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Number of Transactions</label>
                    <input type="number" id="trans1" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Notes (Optional)</label>
                    <textarea id="notes1" placeholder="Enter any notes..."></textarea>
                </div>
            </div>

            <div class="source-panel">
                <h3>Source 2 Sales</h3>
                <div class="input-group">
                    <label>Total Sales Amount ($)</label>
                    <input type="number" id="sales2" step="0.01" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Number of Transactions</label>
                    <input type="number" id="trans2" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Notes (Optional)</label>
                    <textarea id="notes2" placeholder="Enter any notes..."></textarea>
                </div>
            </div>

            <div class="source-panel">
                <h3>Source 3 Sales</h3>
                <div class="input-group">
                    <label>Total Sales Amount ($)</label>
                    <input type="number" id="sales3" step="0.01" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Number of Transactions</label>
                    <input type="number" id="trans3" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Notes (Optional)</label>
                    <textarea id="notes3" placeholder="Enter any notes..."></textarea>
                </div>
            </div>

            <div class="source-panel">
                <h3>Source 4 Sales</h3>
                <div class="input-group">
                    <label>Total Sales Amount ($)</label>
                    <input type="number" id="sales4" step="0.01" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Number of Transactions</label>
                    <input type="number" id="trans4" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Notes (Optional)</label>
                    <textarea id="notes4" placeholder="Enter any notes..."></textarea>
                </div>
            </div>

            <div class="source-panel">
                <h3>Source 5 Sales</h3>
                <div class="input-group">
                    <label>Total Sales Amount ($)</label>
                    <input type="number" id="sales5" step="0.01" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Number of Transactions</label>
                    <input type="number" id="trans5" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Notes (Optional)</label>
                    <textarea id="notes5" placeholder="Enter any notes..."></textarea>
                </div>
            </div>
        </div>

        <div class="manager-notes">
            <h3>Manager Remarks (Optional)</h3>
            <textarea id="managerRemarks" placeholder="Add any notes, observations, or action items..."></textarea>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="generateReport()">Generate Daily Report</button>
            <button class="btn btn-secondary" id="downloadBtn" disabled onclick="downloadPDF()">üìÑ Download PDF</button>
            <button class="btn btn-secondary" id="downloadCsvBtn" disabled onclick="downloadCSV()">üìä Download CSV</button>
            <button class="btn btn-secondary" id="downloadJsonBtn" disabled onclick="downloadJSON()">üìã Download JSON</button>
        </div>

        <div class="report-preview" id="reportPreview">
            <div class="report-header">
                <h2>Daily Sales Summary</h2>
                <p class="date" id="reportDate"></p>
            </div>

            <div class="report-metadata">
                <div class="metadata-item">
                    <span class="metadata-label">Report ID</span>
                    <span class="metadata-value" id="reportId">-</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Generated At</span>
                    <span class="metadata-value" id="reportTimestamp">-</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Report Type</span>
                    <span class="metadata-value">Daily Sales Report</span>
                </div>
            </div>

            <div class="goal-tracking" id="goalTracking" style="display: none;">
                <h3>üìä Daily Goal Tracking</h3>
                <div class="goal-stats">
                    <div class="goal-stat">
                        <div class="goal-stat-label">Target</div>
                        <div class="goal-stat-value" id="targetValue">$0.00</div>
                    </div>
                    <div class="goal-stat">
                        <div class="goal-stat-label">Actual</div>
                        <div class="goal-stat-value" id="actualValue">$0.00</div>
                    </div>
                    <div class="goal-stat">
                        <div class="goal-stat-label">Achievement</div>
                        <div class="goal-stat-value" id="achievementPercent">0%</div>
                    </div>
                </div>
                <div class="goal-status" id="goalStatus">-</div>
            </div>

            <div class="charts-section">
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>Sales per Source</h3>
                        <div class="chart-wrapper">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Sales Contribution %</h3>
                        <div class="chart-wrapper">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <table class="report-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Sales Amount</th>
                        <th>Contribution %</th>
                        <th>Transactions</th>
                        <th>Performance</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                </tbody>
            </table>

            <div class="metrics">
                <h3>Calculated Metrics</h3>
                <div class="metric-item">
                    <span class="metric-label">Average Sale per Transaction:</span>
                    <span class="metric-value" id="avgSale">$0.00</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Average Sales Per Source:</span>
                    <span class="metric-value" id="avgPerSource">$0.00</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Best Performing Source:</span>
                    <span class="metric-value" id="bestSource">-</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Lowest Performing Source:</span>
                    <span class="metric-value" id="worstSource">-</span>
                </div>
            </div>

            <div class="manager-remarks" id="managerRemarksDisplay" style="display: none;">
                <h3>üíº Manager Remarks</h3>
                <div class="manager-remarks-text" id="managerRemarksText"></div>
            </div>
        </div>
    </div>

    <script>
        // Theme Management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDateInput').value = today;
            
            // Initialize role permissions
            updateRolePermissions();
            
            // Load history
            displayHistoricalData();
        });

        // Role-Based Permissions
        function updateRolePermissions() {
            const role = document.getElementById('userRole').value;
            const roleBadge = document.getElementById('roleBadge');
            
            // Update badge
            roleBadge.className = 'role-badge';
            if (role === 'manager') {
                roleBadge.className += ' role-manager';
                roleBadge.textContent = 'MANAGER';
            } else if (role === 'analyst') {
                roleBadge.className += ' role-analyst';
                roleBadge.textContent = 'ANALYST';
            } else {
                roleBadge.className += ' role-viewer';
                roleBadge.textContent = 'VIEWER';
            }
            
            // Get all input fields
            const inputs = document.querySelectorAll('input[type="number"], textarea');
            const managerRemarks = document.getElementById('managerRemarks');
            const generateBtn = document.querySelector('.btn-primary');
            const downloadBtns = document.querySelectorAll('.btn-secondary');
            const saveButtons = document.querySelectorAll('.btn-info');
            const saveNewDayBtn = document.getElementById('saveNewDayBtn');
            
            if (role === 'viewer') {
                // Viewer: Read-only
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.opacity = '0.6';
                });
                generateBtn.style.display = 'none';
                saveButtons.forEach(btn => btn.style.display = 'none');
                saveNewDayBtn.style.display = 'none';
                managerRemarks.disabled = true;
                managerRemarks.style.opacity = '0.6';
            } else if (role === 'analyst') {
                // Analyst: Can edit data and generate reports
                inputs.forEach(input => {
                    input.disabled = false;
                    input.style.opacity = '1';
                });
                generateBtn.style.display = 'inline-block';
                saveButtons.forEach(btn => btn.style.display = 'inline-block');
                saveNewDayBtn.style.display = 'inline-block';
                managerRemarks.disabled = true;
                managerRemarks.style.opacity = '0.6';
                // Hide manager-only download buttons
                downloadBtns.forEach(btn => btn.style.display = 'none');
            } else {
                // Manager: Full access
                inputs.forEach(input => {
                    input.disabled = false;
                    input.style.opacity = '1';
                });
                generateBtn.style.display = 'inline-block';
                saveButtons.forEach(btn => btn.style.display = 'inline-block');
                saveNewDayBtn.style.display = 'inline-block';
                downloadBtns.forEach(btn => btn.style.display = 'inline-block');
                managerRemarks.disabled = false;
                managerRemarks.style.opacity = '1';
            }
        }

        // Input Validation
        function validateInputs() {
            let isValid = true;
            let emptyFields = [];

            for (let i = 1; i <= 5; i++) {
                const salesInput = document.getElementById('sales' + i);
                const transInput = document.getElementById('trans' + i);

                // Remove invalid class first
                salesInput.classList.remove('invalid');
                transInput.classList.remove('invalid');

                const sales = parseFloat(salesInput.value);
                const trans = parseInt(transInput.value);

                // Check for negative numbers
                if (sales < 0 || trans < 0) {
                    if (sales < 0) salesInput.classList.add('invalid');
                    if (trans < 0) transInput.classList.add('invalid');
                    isValid = false;
                    alert('‚ùå Error: Negative values are not allowed in Source ' + i);
                    return false;
                }

                // Check for empty required fields
                if (!salesInput.value || !transInput.value) {
                    if (!salesInput.value) {
                        salesInput.classList.add('invalid');
                        emptyFields.push('Source ' + i + ' - Sales Amount');
                    }
                    if (!transInput.value) {
                        transInput.classList.add('invalid');
                        emptyFields.push('Source ' + i + ' - Transactions');
                    }
                    isValid = false;
                }
            }

            if (emptyFields.length > 0) {
                alert('‚ùå Please fill in the following required fields:\n\n' + emptyFields.join('\n'));
                return false;
            }

            return isValid;
        }

        // Auto Fill Demo Data
        function autoFillDemo() {
            document.getElementById('sales1').value = '12450.50';
            document.getElementById('trans1').value = '145';
            document.getElementById('notes1').value = 'Strong morning sales';

            document.getElementById('sales2').value = '8930.75';
            document.getElementById('trans2').value = '98';
            document.getElementById('notes2').value = 'Slower than expected';

            document.getElementById('sales3').value = '15200.00';
            document.getElementById('trans3').value = '203';
            document.getElementById('notes3').value = 'Best performing source';

            document.getElementById('sales4').value = '6780.25';
            document.getElementById('trans4').value = '67';
            document.getElementById('notes4').value = 'Below target';

            document.getElementById('sales5').value = '10350.00';
            document.getElementById('trans5').value = '128';
            document.getElementById('notes5').value = 'Steady performance';

            document.getElementById('dailyTarget').value = '50000.00';
            document.getElementById('managerRemarks').value = 'Overall strong performance today. Source 3 exceeded expectations. Need to investigate why Source 4 underperformed.';

            alert('‚úÖ Demo data loaded successfully!');
        }

        // Save Report to localStorage
        function saveReport() {
            const reportData = {
                sources: [],
                target: document.getElementById('dailyTarget').value,
                remarks: document.getElementById('managerRemarks').value,
                timestamp: new Date().toISOString()
            };

            for (let i = 1; i <= 5; i++) {
                reportData.sources.push({
                    sales: document.getElementById('sales' + i).value,
                    trans: document.getElementById('trans' + i).value,
                    notes: document.getElementById('notes' + i).value
                });
            }

            localStorage.setItem('lastSalesReport', JSON.stringify(reportData));
            alert('üíæ Report saved successfully!');
        }

        // Load Report from localStorage
        function loadReport() {
            const savedData = localStorage.getItem('lastSalesReport');
            
            if (!savedData) {
                alert('‚ö†Ô∏è No saved report found.');
                return;
            }

            const reportData = JSON.parse(savedData);

            for (let i = 1; i <= 5; i++) {
                const source = reportData.sources[i - 1];
                document.getElementById('sales' + i).value = source.sales;
                document.getElementById('trans' + i).value = source.trans;
                document.getElementById('notes' + i).value = source.notes;
            }

            document.getElementById('dailyTarget').value = reportData.target || '';
            document.getElementById('managerRemarks').value = reportData.remarks || '';

            alert('üìÇ Report loaded successfully!\nSaved on: ' + new Date(reportData.timestamp).toLocaleString());
        }

        // Save as New Day - Multi-Day History Tracking
        function saveAsNewDay() {
            if (!validateInputs()) {
                return;
            }

            const reportDate = document.getElementById('reportDateInput').value;
            if (!reportDate) {
                alert('‚ö†Ô∏è Please select a report date.');
                return;
            }

            const sources = [];
            let totalSales = 0;
            let totalTransactions = 0;

            for (let i = 1; i <= 5; i++) {
                const sales = parseFloat(document.getElementById('sales' + i).value) || 0;
                const trans = parseInt(document.getElementById('trans' + i).value) || 0;
                const notes = document.getElementById('notes' + i).value || '';

                sources.push({
                    sales: sales,
                    trans: trans,
                    notes: notes
                });

                totalSales += sales;
                totalTransactions += trans;
            }

            // Find best source
            let bestSource = 'Source 1';
            let bestSales = sources[0].sales;
            sources.forEach((source, index) => {
                if (source.sales > bestSales) {
                    bestSales = source.sales;
                    bestSource = 'Source ' + (index + 1);
                }
            });

            const target = parseFloat(document.getElementById('dailyTarget').value) || 0;
            const targetMet = target > 0 ? totalSales >= target : null;

            const dayReport = {
                date: reportDate,
                sources: sources,
                totalSales: totalSales,
                totalTransactions: totalTransactions,
                target: target,
                targetMet: targetMet,
                bestSource: bestSource,
                remarks: document.getElementById('managerRemarks').value || '',
                timestamp: new Date().toISOString()
            };

            // Get existing history
            const history = JSON.parse(localStorage.getItem('salesHistory') || '[]');
            
            // Check if report for this date already exists
            const existingIndex = history.findIndex(r => r.date === reportDate);
            if (existingIndex >= 0) {
                if (confirm('A report for ' + reportDate + ' already exists. Do you want to overwrite it?')) {
                    history[existingIndex] = dayReport;
                } else {
                    return;
                }
            } else {
                history.push(dayReport);
            }

            // Sort by date (newest first)
            history.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Save to localStorage
            localStorage.setItem('salesHistory', JSON.stringify(history));

            alert('‚úÖ Report saved for ' + reportDate + '!');
            displayHistoricalData();
            generateSmartAlerts(dayReport, history);
        }

        // Display Historical Data
        function displayHistoricalData() {
            const history = JSON.parse(localStorage.getItem('salesHistory') || '[]');
            const tbody = document.getElementById('historyTableBody');

            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="history-empty">No historical data available. Generate and save reports to see history.</td></tr>';
                return;
            }

            let html = '';
            history.forEach((report, index) => {
                const prevReport = index < history.length - 1 ? history[index + 1] : null;
                let trendHtml = '<span class="trend-neutral">-</span>';

                if (prevReport) {
                    const diff = report.totalSales - prevReport.totalSales;
                    const percentChange = ((diff / prevReport.totalSales) * 100).toFixed(1);
                    
                    if (diff > 0) {
                        trendHtml = `<span class="trend-indicator trend-up">‚Üë ${percentChange}%</span>`;
                    } else if (diff < 0) {
                        trendHtml = `<span class="trend-indicator trend-down">‚Üì ${Math.abs(percentChange)}%</span>`;
                    } else {
                        trendHtml = `<span class="trend-indicator trend-neutral">= 0%</span>`;
                    }
                }

                let targetStatus = '-';
                if (report.target > 0) {
                    if (report.targetMet) {
                        targetStatus = '<span style="color: #28a745; font-weight: 600;">‚úÖ Met</span>';
                    } else {
                        const percent = ((report.totalSales / report.target) * 100).toFixed(0);
                        targetStatus = `<span style="color: #ffc107; font-weight: 600;">‚ö†Ô∏è ${percent}%</span>`;
                    }
                }

                html += `
                    <tr>
                        <td><strong>${report.date}</strong></td>
                        <td>${formatCurrency(report.totalSales)}</td>
                        <td>${trendHtml}</td>
                        <td>${formatNumber(report.totalTransactions)}</td>
                        <td>${targetStatus}</td>
                        <td>${report.bestSource}</td>
                        <td>
                            <button class="btn btn-info btn-small" onclick="loadDayReport('${report.date}')" style="padding: 5px 10px; font-size: 12px;">Load</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDayReport('${report.date}')" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Load Historical Report
        function loadHistoricalReport() {
            const selectedDate = document.getElementById('reportDateInput').value;
            if (!selectedDate) {
                alert('‚ö†Ô∏è Please select a date to load.');
                return;
            }

            loadDayReport(selectedDate);
        }

        // Load Day Report
        function loadDayReport(date) {
            const history = JSON.parse(localStorage.getItem('salesHistory') || '[]');
            const report = history.find(r => r.date === date);

            if (!report) {
                alert('‚ö†Ô∏è No report found for ' + date);
                return;
            }

            // Load data into inputs
            for (let i = 1; i <= 5; i++) {
                const source = report.sources[i - 1];
                document.getElementById('sales' + i).value = source.sales;
                document.getElementById('trans' + i).value = source.trans;
                document.getElementById('notes' + i).value = source.notes;
            }

            document.getElementById('dailyTarget').value = report.target || '';
            document.getElementById('managerRemarks').value = report.remarks || '';
            document.getElementById('reportDateInput').value = report.date;

            alert('üìÇ Report loaded for ' + date);
        }

        // Delete Day Report
        function deleteDayReport(date) {
            if (!confirm('Are you sure you want to delete the report for ' + date + '?')) {
                return;
            }

            let history = JSON.parse(localStorage.getItem('salesHistory') || '[]');
            history = history.filter(r => r.date !== date);
            localStorage.setItem('salesHistory', JSON.stringify(history));

            alert('üóëÔ∏è Report deleted for ' + date);
            displayHistoricalData();
        }

        // Clear All History
        function clearHistory() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL historical data? This cannot be undone.')) {
                return;
            }

            localStorage.removeItem('salesHistory');
            displayHistoricalData();
            document.getElementById('alertsSection').style.display = 'none';
            alert('üóëÔ∏è All history cleared.');
        }

        // Generate Smart Alerts
        function generateSmartAlerts(currentReport, history) {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertsSection = document.getElementById('alertsSection');
            let alerts = [];

            // Get previous day's report
            const prevReport = history.length > 1 ? history[1] : null;

            // Alert: Sales dropped more than 20% vs yesterday
            if (prevReport) {
                const diff = currentReport.totalSales - prevReport.totalSales;
                const percentChange = ((diff / prevReport.totalSales) * 100);

                if (percentChange < -20) {
                    alerts.push({
                        type: 'warning',
                        icon: '‚ö†Ô∏è',
                        message: `Sales dropped ${Math.abs(percentChange).toFixed(1)}% compared to ${prevReport.date}. Investigate potential causes.`
                    });
                } else if (percentChange > 20) {
                    alerts.push({
                        type: 'success',
                        icon: 'üöÄ',
                        message: `Excellent! Sales increased ${percentChange.toFixed(1)}% compared to ${prevReport.date}.`
                    });
                }
            }

            // Alert: New best sales day recorded
            const allTimeBest = Math.max(...history.map(r => r.totalSales));
            if (currentReport.totalSales >= allTimeBest && history.length > 1) {
                alerts.push({
                    type: 'success',
                    icon: 'üèÜ',
                    message: 'New record! This is your best sales day ever with ' + formatCurrency(currentReport.totalSales) + '!'
                });
            }

            // Alert: One source has zero transactions
            currentReport.sources.forEach((source, index) => {
                if (source.trans === 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '‚ùó',
                        message: `Source ${index + 1} has ZERO transactions today. Check if there's a system issue.`
                    });
                }
            });

            // Alert: Target not met
            if (currentReport.target > 0 && !currentReport.targetMet) {
                const percent = ((currentReport.totalSales / currentReport.target) * 100).toFixed(0);
                alerts.push({
                    type: 'warning',
                    icon: 'üìä',
                    message: `Daily target not met. Achieved ${percent}% of target (${formatCurrency(currentReport.totalSales)} / ${formatCurrency(currentReport.target)}).`
                });
            }

            // Alert: Last 7 days trend
            if (history.length >= 7) {
                const last7Days = history.slice(0, 7);
                const avgLast7 = last7Days.reduce((sum, r) => sum + r.totalSales, 0) / 7;
                const percentVsAvg = ((currentReport.totalSales - avgLast7) / avgLast7 * 100);

                if (percentVsAvg > 10) {
                    alerts.push({
                        type: 'info',
                        icon: 'üìà',
                        message: `Performing ${percentVsAvg.toFixed(1)}% above your 7-day average.`
                    });
                } else if (percentVsAvg < -10) {
                    alerts.push({
                        type: 'info',
                        icon: 'üìâ',
                        message: `Performing ${Math.abs(percentVsAvg).toFixed(1)}% below your 7-day average.`
                    });
                }
            }

            // Display alerts
            if (alerts.length > 0) {
                let html = '';
                alerts.forEach(alert => {
                    html += `<div class="alert-item alert-${alert.type}">${alert.icon} ${alert.message}</div>`;
                });
                alertsContainer.innerHTML = html;
                alertsSection.classList.add('active');
                alertsSection.style.display = 'block';
            } else {
                alertsSection.style.display = 'none';
            }
        }

        function formatCurrency(amount) {
            return '$' + parseFloat(amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function formatNumber(num) {
            return parseInt(num || 0).toLocaleString();
        }

        function getCurrentDate() {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date().toLocaleDateString('en-US', options);
        }

        function generateReportId() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const sequence = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
            return `DSR-${year}-${month}-${day}-${sequence}`;
        }

        function getTimestamp() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            };
            return now.toLocaleString('en-US', options);
        }

        let barChartInstance = null;
        let pieChartInstance = null;

        function createCharts(sources, totalSales) {
            // Destroy existing charts if they exist
            if (barChartInstance) {
                barChartInstance.destroy();
            }
            if (pieChartInstance) {
                pieChartInstance.destroy();
            }

            const labels = sources.map(s => s.name);
            const salesData = sources.map(s => s.sales);
            const contributionData = sources.map(s => totalSales > 0 ? (s.sales / totalSales * 100) : 0);

            // Bar Chart - Sales per Source
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales Amount ($)',
                        data: salesData,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(118, 75, 162, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Sales: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Pie Chart - Sales Contribution %
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: contributionData,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(118, 75, 162, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateReport() {
            // Validate inputs first
            if (!validateInputs()) {
                return;
            }

            const sources = [];
            let totalSales = 0;
            let totalTransactions = 0;

            for (let i = 1; i <= 5; i++) {
                const sales = parseFloat(document.getElementById('sales' + i).value) || 0;
                const trans = parseInt(document.getElementById('trans' + i).value) || 0;
                const notes = document.getElementById('notes' + i).value || '-';

                sources.push({
                    name: 'Source ' + i,
                    sales: sales,
                    transactions: trans,
                    notes: notes
                });

                totalSales += sales;
                totalTransactions += trans;
            }

            const avgSale = totalTransactions > 0 ? totalSales / totalTransactions : 0;
            const avgPerSource = totalSales / 5;

            // Find best and worst performing sources
            let bestSource = sources[0];
            let worstSource = sources[0];
            
            sources.forEach(source => {
                if (source.sales > bestSource.sales) {
                    bestSource = source;
                }
                if (source.sales < worstSource.sales) {
                    worstSource = source;
                }
            });

            document.getElementById('reportDate').textContent = getCurrentDate();

            // Set Report ID and Timestamp
            document.getElementById('reportId').textContent = generateReportId();
            document.getElementById('reportTimestamp').textContent = getTimestamp();

            // Handle Daily Goal Tracking
            const targetInput = document.getElementById('dailyTarget').value;
            if (targetInput && parseFloat(targetInput) > 0) {
                const target = parseFloat(targetInput);
                const achievementPercent = (totalSales / target * 100);
                
                document.getElementById('goalTracking').style.display = 'block';
                document.getElementById('targetValue').textContent = formatCurrency(target);
                document.getElementById('actualValue').textContent = formatCurrency(totalSales);
                document.getElementById('achievementPercent').textContent = achievementPercent.toFixed(1) + '%';
                
                const goalStatus = document.getElementById('goalStatus');
                if (totalSales >= target) {
                    goalStatus.textContent = '‚úÖ Target Met';
                    goalStatus.className = 'goal-status met';
                } else {
                    goalStatus.textContent = '‚ö†Ô∏è Below Target';
                    goalStatus.className = 'goal-status not-met';
                }
            } else {
                document.getElementById('goalTracking').style.display = 'none';
            }

            // Handle Manager Remarks
            const remarks = document.getElementById('managerRemarks').value;
            if (remarks && remarks.trim()) {
                document.getElementById('managerRemarksDisplay').style.display = 'block';
                document.getElementById('managerRemarksText').textContent = remarks;
            } else {
                document.getElementById('managerRemarksDisplay').style.display = 'none';
            }

            // Create Charts
            createCharts(sources, totalSales);

            let tableHTML = '';
            sources.forEach(source => {
                const contribution = totalSales > 0 ? (source.sales / totalSales * 100) : 0;
                
                let performanceBadge = '';
                let performanceClass = '';
                
                if (source.sales > avgPerSource) {
                    performanceBadge = 'Above Average';
                    performanceClass = 'performance-above';
                } else if (source.sales < avgPerSource) {
                    performanceBadge = 'Below Average';
                    performanceClass = 'performance-below';
                } else {
                    performanceBadge = 'Average';
                    performanceClass = 'performance-average';
                }

                tableHTML += `
                    <tr>
                        <td>${source.name}</td>
                        <td>${formatCurrency(source.sales)}</td>
                        <td>${contribution.toFixed(1)}%</td>
                        <td>${formatNumber(source.transactions)}</td>
                        <td><span class="performance-badge ${performanceClass}">${performanceBadge}</span></td>
                        <td>${source.notes}</td>
                    </tr>
                `;
            });

            tableHTML += `
                <tr class="totals-row">
                    <td><strong>TOTALS</strong></td>
                    <td><strong>${formatCurrency(totalSales)}</strong></td>
                    <td><strong>100.0%</strong></td>
                    <td><strong>${formatNumber(totalTransactions)}</strong></td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            `;

            document.getElementById('reportTableBody').innerHTML = tableHTML;
            document.getElementById('avgSale').textContent = formatCurrency(avgSale);
            document.getElementById('avgPerSource').textContent = formatCurrency(avgPerSource);
            document.getElementById('bestSource').textContent = `${bestSource.name} (${formatCurrency(bestSource.sales)})`;
            document.getElementById('worstSource').textContent = `${worstSource.name} (${formatCurrency(worstSource.sales)})`;

            document.getElementById('reportPreview').classList.add('active');
            
            const role = document.getElementById('userRole').value;
            if (role === 'manager') {
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('downloadCsvBtn').disabled = false;
                document.getElementById('downloadJsonBtn').disabled = false;
            } else {
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('downloadCsvBtn').disabled = true;
                document.getElementById('downloadJsonBtn').disabled = true;
            }

            document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });

            // Check if we should generate alerts (if this report is already saved)
            const reportDate = document.getElementById('reportDateInput').value;
            const history = JSON.parse(localStorage.getItem('salesHistory') || '[]');
            const existingReport = history.find(r => r.date === reportDate);
            
            if (existingReport) {
                // Report exists, generate alerts
                generateSmartAlerts(existingReport, history);
            }
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const reportElement = document.getElementById('reportPreview');
            
            try {
                const canvas = await html2canvas(reportElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                const fileName = 'Daily_Sales_Report_' + new Date().toISOString().split('T')[0] + '.pdf';
                pdf.save(fileName);
            } catch (error) {
                alert('Error generating PDF. Please try again.');
                console.error('PDF generation error:', error);
            }
        }

        // Download CSV Export
        function downloadCSV() {
            const sources = [];
            let totalSales = 0;
            let totalTransactions = 0;

            for (let i = 1; i <= 5; i++) {
                const sales = parseFloat(document.getElementById('sales' + i).value) || 0;
                const trans = parseInt(document.getElementById('trans' + i).value) || 0;
                const notes = document.getElementById('notes' + i).value || '';

                sources.push({
                    source: 'Source ' + i,
                    sales: sales,
                    transactions: trans,
                    contribution: 0,
                    notes: notes
                });

                totalSales += sales;
                totalTransactions += trans;
            }

            // Calculate contribution percentages
            sources.forEach(source => {
                source.contribution = totalSales > 0 ? (source.sales / totalSales * 100).toFixed(1) : 0;
            });

            // Create CSV content
            let csv = 'Source,Sales Amount,Contribution %,Transactions,Notes\n';
            
            sources.forEach(source => {
                csv += `${source.source},${source.sales},${source.contribution}%,${source.transactions},"${source.notes}"\n`;
            });

            csv += `\nTOTALS,${totalSales},100.0%,${totalTransactions},\n`;
            
            // Add metadata
            csv += `\nReport ID,${document.getElementById('reportId').textContent}\n`;
            csv += `Generated At,${document.getElementById('reportTimestamp').textContent}\n`;
            
            const avgSale = totalTransactions > 0 ? totalSales / totalTransactions : 0;
            csv += `\nAverage Sale per Transaction,${avgSale.toFixed(2)}\n`;
            csv += `Average Sales Per Source,${(totalSales / 5).toFixed(2)}\n`;

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Daily_Sales_Report_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Download JSON Export
        function downloadJSON() {
            const sources = [];
            let totalSales = 0;
            let totalTransactions = 0;

            for (let i = 1; i <= 5; i++) {
                const sales = parseFloat(document.getElementById('sales' + i).value) || 0;
                const trans = parseInt(document.getElementById('trans' + i).value) || 0;
                const notes = document.getElementById('notes' + i).value || '';

                sources.push({
                    source: 'Source ' + i,
                    salesAmount: sales,
                    transactions: trans,
                    notes: notes
                });

                totalSales += sales;
                totalTransactions += trans;
            }

            // Calculate metrics
            sources.forEach(source => {
                source.contributionPercent = totalSales > 0 ? parseFloat((source.salesAmount / totalSales * 100).toFixed(1)) : 0;
            });

            const avgSale = totalTransactions > 0 ? totalSales / totalTransactions : 0;
            const avgPerSource = totalSales / 5;

            let bestSource = sources[0];
            let worstSource = sources[0];
            sources.forEach(source => {
                if (source.salesAmount > bestSource.salesAmount) bestSource = source;
                if (source.salesAmount < worstSource.salesAmount) worstSource = source;
            });

            // Build JSON object
            const reportData = {
                reportMetadata: {
                    reportId: document.getElementById('reportId').textContent,
                    generatedAt: document.getElementById('reportTimestamp').textContent,
                    reportType: 'Daily Sales Report'
                },
                sources: sources,
                totals: {
                    totalSales: totalSales,
                    totalTransactions: totalTransactions
                },
                metrics: {
                    averageSalePerTransaction: parseFloat(avgSale.toFixed(2)),
                    averageSalesPerSource: parseFloat(avgPerSource.toFixed(2)),
                    bestPerformingSource: {
                        name: bestSource.source,
                        sales: bestSource.salesAmount
                    },
                    lowestPerformingSource: {
                        name: worstSource.source,
                        sales: worstSource.salesAmount
                    }
                }
            };

            // Add goal tracking if exists
            const targetInput = document.getElementById('dailyTarget').value;
            if (targetInput && parseFloat(targetInput) > 0) {
                const target = parseFloat(targetInput);
                reportData.goalTracking = {
                    target: target,
                    actual: totalSales,
                    achievementPercent: parseFloat((totalSales / target * 100).toFixed(1)),
                    targetMet: totalSales >= target
                };
            }

            // Add manager remarks if exists
            const remarks = document.getElementById('managerRemarks').value;
            if (remarks && remarks.trim()) {
                reportData.managerRemarks = remarks;
            }

            // Download JSON
            const jsonStr = JSON.stringify(reportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Daily_Sales_Report_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
